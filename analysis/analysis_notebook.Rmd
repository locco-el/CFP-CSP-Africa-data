---
title: "Effect of CFP on CSR"
output:
  html_document:
    df_print: paged
  html_notebook: default
  pdf_document: default
---
# Statistical analysis

## Initial setup

- Using renv to lock in dependencies
- Using git for version control
- Created an r project

```{r env_and_dependencies, echo=FALSE, warning=FALSE}

#all_data <- fread(file = 'rawdata/rawdata.csv', header = TRUE)
library(CSPandCFP)
library(desctable)
library(dplyr)
library(huxtable)
library(broom)
library(tidyr)
library(corrplot)
library(ggplot2)
library(ggfortify)
library(factoextra)

data("pca_data")


```


## Data prep

- Load and examine data

```{r load_explore_data, echo = F}

class(pca_data)
str(pca_data)
head(pca_data)
lapply(pca_data, summary)

```

### Descriptive table (table 1)

```{r tab1_pca_desc_table}

desc_stats <- list('Mean' = mean, 'Median' = median, 'SD' = sd, 'Min' = min, 'Max' = max)
var_labels <- c('Education', 'Public health', 'Arts and culture', 'Economy', 'Agriculture', 'Social activism', 
                'Workplace safety', 'Workforce diversity', 'Employee training', 'Employee benefits', 'Workplace monitoring', 'Employee satisfaction',
                'Product information', 'Product quality',
                'Energy conservation', 'Energy policy', 
                'Emissions policy', 'Emissions-reduction practices',
                'Pollution-reduction', 'Conservation activities', 'Environmental Policy', 'Water policy', 
                'Other CSR activities')

pca_vars <- names(pca_data)[grepl('^n_', names(pca_data))]
names(var_labels) <- pca_vars

pca_data %>%
  select(all_of(pca_vars)) %>% 
  desctable(stats = desc_stats, labels = var_labels) %>%
  as.data.frame %>% 
  hux %>% 
  set_header_rows(1, TRUE) %>% 
  style_headers(bold = TRUE, text_color = "grey40") %>% 
  set_caption('Summary of CSR domain variables') %>% 
  theme_article()

```

```{r fig1_pairwise_correlations_plot, fig.cap = 'Pairwise correlations for CSR variables'}

pca_data %>%
  select(all_of(pca_vars)) %>%
  setnames(pca_vars, var_labels) %>% 
  cor %>%
  corrplot(type = 'lower', tl.cex = .7)

```


### PCA analysis

```{r pca_analysis}

pca_data %>%
  select(all_of(pca_vars)) %>%
  prcomp(center = T, rank. = 10) -> pca_res

```

```{r tab2_perc_var_explained}

pca_res %>%
  tidy(matrix = 'd') %>%
  slice(1:10) %>% 
  mutate(percent = percent*100, cumulative = cumulative*100) %>% 
  as_hux -> tab
  
tab %>% 
  set_header_rows(1, TRUE) %>% 
  set_contents(1, 1:4, c("Prin. Comp", "Std. Dev.", "% explained", "Cummulative %")) %>% 
  style_headers(bold = TRUE, text_color = "grey40") %>% 
  set_caption('Percentage of variance explained by first 10 principal components') %>% 
  theme_article()

```

```{r component_loadings_table}

pca_res %>%
  tidy(matrix = 'v') %>%
  spread(key = PC, value = value) %>%
  select(-column) %>%
  mutate(`CSR domain` = var_labels) %>%
  relocate(`CSR domain`) %>%
  hux -> tab
  
tab %>% insert_row('', 'Principal component', '', '', '', '', '', '', '', '', '', after = 0) %>%
  merge_cells(1, 2:11) %>%
  set_col_width(c(1, rep(.5, 10))) %>% 
  set_header_rows(1:2, TRUE) %>% 
  style_headers(bold = TRUE, text_color = "grey40") %>% 
  set_caption('Loadings of CSR domains on first 10 principal components') %>% 
  theme_article()

```


### PCA results (Figures)

```{r fig1_sector_loadings, fig.cap='PCA Component Loadings by industrial sector'}

# Component loadings

rownames(pca_res$rotation) <- var_labels
pca_res$rotation

autoplot(pca_res, data = pca_data, colour = 'Sector', loadings = T, 
         loadings.label = TRUE, loadings.label.size = 3, 
         frame = T)

```
```{r fig2_country_loadings, fig.cap='PCA Component Loadings by industrial sector'}

autoplot(pca_res, data = pca_data, colour = 'Country', loadings = T, 
         loadings.label = TRUE, loadings.label.size = 3, 
         frame = T)

```
```{r fig3_screeplot, fig.cap='Screeplot of PCA components'}

fviz_eig(pca_res) + ggtitle("") + labs(x = 'Principal component')
```


### Predicted PCA scores

```{r}

# Results for individuals
res_ind <- get_pca_ind(pca_res)
pca_ind_scores <- res_ind$coord[, 1]        # Coordinates

usethis::use_data(pca_ind_scores, overwrite = TRUE)

```

```{r fig4_pred_score_pc1, fig.cap='Predicted Scores from first principal component'}

ggplot() + aes(pca_ind_scores) + 
  geom_density() +
  labs(x = "Predicted Score",
       y = "Frequency")
```


```{r fig5_pred_score_sector, fig.cap='PCA Scores by Sector'}

pca_data$score <- pca_ind_scores
ggplot(pca_data, aes(score, colour = pca_data$Sector)) + 
  geom_boxplot() + 
  labs(x = "Predicted Score",
       y = "Frequency",
       colour = "Sector") 

```

```{r fig6_pred_score_country, fig.cap="PCA Scores by Sector"}

ggplot(pca_data, aes(score, colour = pca_data$Country)) + 
  geom_boxplot() + 
  labs(x = "Predicted Score",
       y = "Frequency",
       colour = "Country") 

```




## Analysis for Paper 2

General notes on analysis 
- Listing age (reporting year - listing year) may be < 0 as some companies reported whiles still private (these companies later got listed)
  - Consider excluding them or using incorporation age in analysis
  - including them may violate the condition that only listed companies are studied
  
- Multinational/local status implies that company may be required to report based on regulations from parent company's country even if local country regulations do not

- Country of listing may be different from country of operation

- Sector:
  - Primary implies agriculture, extractive etc. Such companies face greater pressure to perform CSR 

Covariates for Paper 2
- company age (incorporation age, listing age): include both
- Sector: primary secondary tertiary
- Firm size (ln(total assets))

Interaction variables
- Presence of corporate social responsibility function

non linearity in relationship

### Subset data to use

- Net profit, total assets and book value of equity variables were coerced to strings in the data import even though they are supposed to be numeric. They are first converted to numeric by deleting all non-numeric characters

```{r dependencies_data_options}

library(lmtest)
library(sandwich)
library(dplyr)
library(CSPandCFP)
library(huxtable)
library(desctable)
library(data.table)
library(gtsummary)
library(labelled)
library(ggfortify)
library(ggplot2)

# load regression data
data('reg_data')
data('pca_ind_scores')

names(reg_data)
str(reg_data)
```


```{r final_data_prep, echo=F}

# Add first component scores to dataset
reg_data[, pca_score := pca_ind_scores]

# also, delete tobin's q and listing age o/a of excessive numbers of missing values
# specifically, all companies from South Africa are missing for tobin's q
reg_data %>% select(-c(listing_age))

# summarize data
lapply(reg_data_pca, summary)

```


```{r tab1_desc_stats}

reg_data %>% 
  set_variable_labels(
    listing_age = 'Listing age',
    incorp_age = 'Incorporation age',
    lag_return_on_assets = 'Return on assets',
    lag_return_on_equity = 'Return on equity',
    reporting_year = 'Report year',
    pca_score = 'PCA score',
    social_committee = 'Has social/ethics committee'
  ) %>% 
  set_value_labels(
    social_committee = c(Yes = 1, No = 0)
  ) %>% 
  tbl_summary(by = social_committee, missing = 'no') %>%
  add_p -> sumtable
  
sumtable %>% 
  as_hux_table %>% 
  insert_row('', 'Has Social and Ethics Committee', '', '', after = 0) %>%
  merge_cells(1, 2:3) %>%
  set_header_rows(1:2, TRUE) %>% 
  style_headers(bold = TRUE, text_color = "grey40") %>% 
  set_caption('Descriptive Statistics') %>% 
  theme_article()

                
```



```{r model_formulas, echo=F}

#names(reg_data)
indep_vars <- c('lag_return_on_assets', 'lag_return_on_equity')
covs <- 'reporting_year + Country + Sector + incorp_age + social_committee'
non_lin_terms <- sapply(indep_vars, function(x) paste0( x, ' + I(', x, '**2)', ' + I(', x, '**3)'))
inter_terms <- sapply(indep_vars, function(x) 
  paste0( '(', x, ' + I(', x, '**2)', ' + I(', x, '**3))*social_committee'))
int_adj_terms <- 
  sapply(non_lin_terms, 
         function(x) paste0('(', x, ' + ', covs, ')', '*social_committee'))

unadj_models <- paste('pca_score', indep_vars, sep = ' ~ ')
adj_models <- paste(unadj_models, covs, sep = ' + ')

non_lin_unadj_models <- paste('pca_score', non_lin_terms, sep = ' ~ ')
non_lin_adj_models <- paste(non_lin_unadj_models, covs, sep = ' + ')

inter_unadj_models <- paste('pca_score', paste0(inter_terms), sep = ' ~ ')
inter_adj_models <- paste('pca_score', int_adj_terms, sep = ' ~ ')

models <- c(unadj_models, adj_models, non_lin_unadj_models, 
            non_lin_adj_models, inter_unadj_models, inter_adj_models)

models
```

```{r fit_models}


model_fits <- lapply(models, lm, data = reg_data)
fits <- lapply(model_fits, function(x) coeftest(x, vcov = vcovHC(x, type="HC1")))

```

```{r linear_mod_tables}

lab <- c(
  "Return on assets" = "lag_return_on_assets",
  "Return on equity" = "lag_return_on_equity",
  "Reporting year : 2015" = "reporting_year2015",
  "Reporting year : 2016" = "reporting_year2016",
  "Reporting year : 2017" = "reporting_year2017",
  "Reporting year : 2018" = "reporting_year2018",
  "Country: Ghana" = "CountryGhana",
  "Country: Kenya" = "CountryKenya",
  "Country: Mauritius" = "CountryMauritius",
  "Country: Nigeria" = "CountryNigeria",
  "Country: South Africa" = "CountrySouth Africa", 
  "Sector: Secondary" = "SectorSecondary", 
  "Sector: Secondary" = "SectorTertiary", 
  "Incorporation age" = "incorp_age", 
  "Social committee" = "social_committee1"
)


huxreg(fits[1:4],
       error_pos = 'right', ci_level = .95, error_format = "({conf.low}, {conf.high})", number_format = 3, 
       statistics = c('nobs', 'AIC'), coefs = lab) %>% 
  set_contents(1, 2:9, c(rep('Unadjusted', 4), rep('Adjusted', 4))) %>% 
  set_col_width(c(.2, rep(.1, 8))) %>%
  set_header_rows(1, TRUE) %>% 
  style_headers(bold = TRUE, text_color = "grey40") %>% 
  set_caption('Linear models') %>% 
  merge_cells(row = 1, col = c(2, 3)) %>% 
  merge_cells(row = 1, col = c(4, 5)) %>% 
  merge_cells(row = 1, col = c(6, 7)) %>% 
  merge_cells(row = 1, col = c(8, 9)) %>% 
  theme_article()

```

```{r non_linear_mod_tables}

lab <- c(
  "Return on assets" = "lag_return_on_assets",
  "ROA**2" = "I(lag_return_on_assets^2)",
  "ROA**3" = "I(lag_return_on_assets^3)",
  "Return on equity" = "lag_return_on_equity",
  "ROE**2" = "I(lag_return_on_equity^2)",
  "ROE**3" = "I(lag_return_on_equity^3)",
  "Reporting year : 2015" = "reporting_year2015",
  "Reporting year : 2016" = "reporting_year2016",
  "Reporting year : 2017" = "reporting_year2017",
  "Reporting year : 2018" = "reporting_year2018",
  "Country: Ghana" = "CountryGhana",
  "Country: Kenya" = "CountryKenya",
  "Country: Mauritius" = "CountryMauritius",
  "Country: Nigeria" = "CountryNigeria",
  "Country: South Africa" = "CountrySouth Africa", 
  "Sector: Secondary" = "SectorSecondary", 
  "Sector: Secondary" = "SectorTertiary", 
  "Incorporation age" = "incorp_age", 
  "Social committee" = "social_committee1"
)


huxreg(fits[5:8],
       error_pos = 'right', ci_level = .95, error_format = "({conf.low}, {conf.high})", number_format = 3, 
       statistics = c('nobs', 'AIC'), coefs = lab) %>% 
  set_contents(1, 2:9, c(rep('Unadjusted', 4), rep('Adjusted', 4))) %>% 
  set_col_width(c(.2, rep(.1, 8))) %>%
  set_header_rows(1, TRUE) %>% 
  style_headers(bold = TRUE, text_color = "grey40") %>% 
  set_caption('Non-linear models') %>% 
  merge_cells(row = 1, col = c(2, 3)) %>% 
  merge_cells(row = 1, col = c(4, 5)) %>% 
  merge_cells(row = 1, col = c(6, 7)) %>% 
  merge_cells(row = 1, col = c(8, 9)) %>% 
  theme_article() %>% 
  add_footnote('Adjusted models are adjusted for country and year fixed-effects terms, industrial sector, incoporation year and presence of a social and ethics committee')

```

```{r interaction_mod_tables}

lab <- c(
  "Return on assets" = "lag_return_on_assets",
  "ROA**2" = "I(lag_return_on_assets^2)",
  "ROA**3" = "I(lag_return_on_assets^3)",
  "Return on equity" = "lag_return_on_equity",
  "ROE**2" = "I(lag_return_on_equity^2)",
  "ROE**3" = "I(lag_return_on_equity^3)",
  "ROE x SC" = "lag_return_on_equity:social_committee1",
  "ROA x SC" = "lag_return_on_assets:social_committee1"
)

huxreg(fits[9:12],
       error_pos = 'right', ci_level = .95, error_format = "({conf.low}, {conf.high})", number_format = 3, 
       statistics = c("N" = "nobs"), coefs = lab) %>% 
  set_contents(1, 2:9, c(rep('Unadjusted', 4), rep('Adjusted', 4))) %>% 
  set_col_width(c(.2, rep(.1, 8))) %>%
  set_header_rows(1, TRUE) %>% 
  style_headers(bold = TRUE, text_color = "grey40") %>% 
  set_caption('Non-linear models') %>% 
  merge_cells(row = 1, col = c(2, 3)) %>% 
  merge_cells(row = 1, col = c(4, 5)) %>% 
  merge_cells(row = 1, col = c(6, 7)) %>% 
  merge_cells(row = 1, col = c(8, 9)) %>% 
  theme_article() %>% 
  add_footnote('Models include interaction terms between SC and all other adjustment variables. 
  Adjusted models are adjusted for country and year fixed-effects terms, industrial sector, 
  incoporation year and presence of a social and ethics committee')


```

```{r lr_tests}

lr_tests <- data.frame(
  `Models to compare` = c('Non-linear unadjusted vs. linear unadjusted (ROA)', 
                          'Non-linear unadjusted vs. linear unadjusted (ROE)', 
                          'Non-linear adjusted vs. linear adjusted (ROA)', 
                          'Non-linear adjusted vs. linear adjusted (ROE)',
                          'Unadjusted interaction vs. non-linear unadjusted (ROA)', 
                          'Unadjusted interaction vs. non-linear unadjusted (ROE)', 
                          'Adjusted interaction vs. non-linear adjusted (ROA)', 
                          'Adjusted interaction vs. non-linear adjusted (ROE)'),
                          
  'p-values' = c(
    lrtest(model_fits[[5]], model_fits[[1]])[['Pr(>Chisq)']][[2]],
    lrtest(model_fits[[6]], model_fits[[2]])[['Pr(>Chisq)']][[2]],
    lrtest(model_fits[[7]], model_fits[[3]])[['Pr(>Chisq)']][[2]],
    lrtest(model_fits[[8]], model_fits[[4]])[['Pr(>Chisq)']][[2]],
    lrtest(model_fits[[9]], model_fits[[5]])[['Pr(>Chisq)']][[2]],
    lrtest(model_fits[[10]], model_fits[[6]])[['Pr(>Chisq)']][[2]],
    lrtest(model_fits[[11]], model_fits[[7]])[['Pr(>Chisq)']][[2]],
    lrtest(model_fits[[12]], model_fits[[8]])[['Pr(>Chisq)']][[2]])
  ) %>% 
  data.frame %>% 
  hux %>% 
  set_header_rows(1, TRUE) %>% 
  style_headers(bold = TRUE, text_color = "grey40") %>% 
  theme_article()

lr_tests
```


### Plot non-linearity

```{r plot_prep}

non_lin_models <- model_fits[c(5, 6, 9, 10)]
aug_models <- lapply(non_lin_models, broom::augment)

model_names <- c('roa_nonlin', 'roe_nonlin', 'roa_inter', 'roe_inter')
names(aug_models) <- model_names
model_vars <- c('lag_return_on_assets', 'lag_return_on_equity', 'lag_return_on_assets', 'lag_return_on_equity')

```

```{r plot non-linear ROA, fig.cap='Non-linearity in CSR score across range of return on assets'}

ggplot(aug_models[['roa_nonlin']], aes(x = lag_return_on_assets, y = .fitted)) + 
  geom_point(color = 'blue') + geom_line() + 
  geom_point(aes(x = lag_return_on_assets, y = pca_score), color = 'red',  alpha = .1) +
  labs(x = "Return on assets", y = "CSR score")

```

```{r plot non-linear ROE, fig.cap='Non-linearity in CSR score across range of return on equity'}

ggplot(aug_models[['roe_nonlin']], aes(x = lag_return_on_equity, y = .fitted)) + 
  geom_point(color = 'blue') + geom_line() + 
  geom_point(aes(x = lag_return_on_equity, y = pca_score), color = 'red', alpha = .1) +
  labs(x = "Return on assets", y = "CSR score")

```

```{r plot non-linear ROA by SC, fig.cap='Non-linearity in CSR score across range of return on assets by existence of social committee'}

ggplot(aug_models[['roa_inter']], aes(x = lag_return_on_assets, y = .fitted, color = social_committee)) + 
  geom_point() + geom_line() + 
  geom_point(aes(x = lag_return_on_assets, y = pca_score, color = social_committee), alpha = .1) +
  labs(x = "Return on assets", y = "CSR score")

```

```{r plot non-linear ROE by SC, fig.cap='Non-linearity in CSR score across range of return on equity by existence of social committee'}

ggplot(aug_models[['roe_inter']], aes(x = lag_return_on_equity, y = .fitted, color = social_committee)) + 
  geom_point() + geom_line() + 
  geom_point(aes(x = lag_return_on_equity, y = pca_score, color = social_committee),  alpha = .1) +
  labs(x = "Return on equity", y = "CSR score")

```
